# é¾™å¹´è´´èŠ±â€”â€”æ‰“é€ å±äºä½ çš„æ¶‚é¸¦ä¹‹é¾™

# å‰è¨€

è¾æ—§è¿æ–°ï¼Œé­ç‚®é˜µé˜µã€‚ä¸çŸ¥ä¸è§‰ä¸­åˆè¿‡å®Œäº†ä¸€å¹´ï¼Œæˆ‘ä»¬å³å°†è¿æ¥é¾™å¹´ï¼Œåœ¨è¿™é‡Œå…ˆç»™å¤§å®¶æ‹œä¸ªæ—©å¹´äº†ï¼ãŠ—ï¸å¤§å®¶ï¼š

> - åœ¨æ–°çš„ä¸€å¹´é‡Œï¼Œæ„¿æ‚¨çš„ä»£ç å†™å¾—æ›´åŠ ä¼˜é›…ï¼Œç¨‹åºè¿è¡Œæ›´åŠ é¡ºç•…ï¼Œç”Ÿæ´»ä¹Ÿå¦‚åŒä¸€æ®µå®Œç¾çš„ä»£ç ï¼Œæ²¡æœ‰bugã€‚
> - 2024å¹´å·²ç»å¯åŠ¨ï¼Œæ„¿æ‚¨åœ¨æ–°çš„è®¡ç®—å¹´ä»£é‡Œï¼Œäº‹ä¸šèƒ½å¤Ÿå®ç°é«˜æ€§èƒ½ï¼Œå¹¸ç¦å€¼è¾¾åˆ°æœ€å¤§ã€‚
> - ä»£ç å¦‚é¾™ï¼Œä¼˜åŒ–å¦‚é£ï¼Œç¥æ‚¨åœ¨æ–°çš„ä¸€å¹´é‡Œç¼–ç»‡å‡ºæ›´å¤šç²¾å½©çš„ç¨‹åºï¼Œå®ç°æ— é™å¯èƒ½ã€‚
> - æ–°å¹´ä¼Šå§‹ï¼Œè®©æˆ‘ä»¬ä¸€èµ·æ¥è§£å†³æ–°çš„é—®é¢˜ï¼Œå¼€å‘æ–°çš„åŠŸèƒ½ï¼Œå…±åŒæ„å»ºæ›´åŠ æ™ºèƒ½çš„æœªæ¥ã€‚
> - æ„¿æ‚¨çš„ç½‘ç»œè¿æ¥ç•…é€šæ— é˜»ï¼Œæ•°æ®å­˜å‚¨æ°¸ä¸æº¢å‡ºï¼Œæ–°å¹´å¦‚åŒé«˜é€Ÿå…‰çº¤ä¸€æ ·å¿«é€Ÿè€Œç¨³å®šã€‚
> - ç¥æ‚¨çš„ç”Ÿæ´»åƒæºä»£ç ä¸€æ ·æ¸…æ™°æ˜“è¯»ï¼Œbugè¶Šæ¥è¶Šå°‘ï¼ŒåŠŸèƒ½å‡çº§è¶Šæ¥è¶Šå¤šã€‚
> - 2024å¹´ï¼Œè®©æˆ‘ä»¬ä¸€åŒè¿æ¥æ›´é«˜ç‰ˆæœ¬çš„è‡ªå·±ï¼Œç¨‹åºäººç”Ÿæ›´ä¸Šä¸€å±‚æ¥¼ã€‚
> - ç¥æ‚¨åœ¨æ–°çš„ä¸€å¹´é‡Œï¼Œæ“ä½œç³»ç»Ÿç¨³å¦‚è€çŸ³ï¼Œè½¯ä»¶å‡çº§å¦‚æ˜¥é£ï¼Œç¡¬ä»¶é…ç½®æ›´ä¸Šä¸€å±‚æ¥¼ã€‚
> - æ„¿æ‚¨çš„å¯†ç åšå¦‚ç£çŸ³ï¼Œç½‘ç»œé˜²ç«å¢™ç‰¢ä¸å¯ç ´ï¼Œæ–°å¹´å®‰å…¨æ— è™ã€‚
> - åœ¨è¿™ä¸ªæ•°æ®æ—¶ä»£ï¼Œç¥æ‚¨çš„æ–°å¹´å……æ»¡æ— é™çš„æ•°æ®æµï¼Œç”Ÿæ´»å……æ»¡ç²¾å½©çš„ç®—æ³•ã€‚

å½“ç„¶ï¼Œä»¥ä¸Šç¥ç¦è¯­æ¥è‡ªäºChatGPTï¼Œè¿™ä¹Ÿç¬¦åˆå’±ä»¬ç¨‹åºå‘˜çš„ä¸€è´¯ä½œé£ğŸ˜ã€‚



å’³å’³ï¼Œå¥½åƒæœ‰ç‚¹è·‘é¢˜ï¼Œå’±ä»¬ä»Šå¤©æ¥æ•´ç‚¹æ´»ã€‚é¾™å¹´ï¼Œè®©æˆ‘æƒ³èµ·æ¥äº†è®¡ç®—æœºå›¾å½¢å­¦ç•Œä¹Ÿæœ‰ä¸€æ¡é¾™ï¼Œå®ƒå°±æ˜¯å¤§åé¼é¼çš„æ–¯å¦ç¦é¾™(Stanford Dragon)ï¼Œå°±æ˜¯ä¸‹é¢è¿™æ¡å•¦ã€‚è¿™æ¡é¾™ç«Ÿç„¶è¢«ç”¨æ¥å½“åšå„ç±»æ¸²æŸ“ä¾‹å­çš„æ¨¡ç‰¹ã€‚



è€Œæˆ‘ä»¬ä»Šå¤©çš„ä¸»è§’å°±æ˜¯è¿™æ¡é¾™æ²¡é”™å•¦ï¼æˆ‘ä»¬ä»Šå¤©å°±åœ¨è¿™æ¡é¾™ä¸Šæ¶‚é¸¦ï¼Œæ‰“é€ ä¸€æ¡å±äºæˆ‘ä»¬è‡ªå·±çš„é¾™ã€‚

![image-20240125161911443](https://picbed-1255660905.cos.ap-chengdu.myqcloud.com/doc/image-20240125161911443.png)

# ç¼–ç å®ç°åŠæ€è·¯ä»‹ç»

æˆ‘ä»¬ä»Šå¤©é‡‡ç”¨çš„æŠ€æœ¯æ ˆå½“ç„¶å°±æ˜¯ä½¿ç”¨THREEJSå•¦~ THREEJSä¸ºæˆ‘ä»¬æä¾›äº†éå¸¸ä¾¿åˆ©çš„è´´èŠ±åŠŸèƒ½æ¥å®ç°ã€‚å¤§å®¶å¯ä»¥ç›´æ¥å‚è€ƒTHREEJSæä¾›çš„å®˜æ–¹Demo [three.js examples (threejs.org)](https://threejs.org/examples/?q=decal#webgl_decals) å’Œä»£ç [three.js/examples/webgl_decals.html at master Â· mrdoob/three.js (github.com)](https://github.com/mrdoob/three.js/blob/master/examples/webgl_decals.html)



è€Œæˆ‘ä»¬ä»Šå¤©åšçš„å°±æ˜¯å¯¹å…¶è¿›è¡Œå°å°çš„è°ƒæ•´å°±å¯ä»¥å•¦~

å®˜æ–¹çš„demoå¯ä»¥è¯´æ˜¯éå¸¸çš„è¯¦ç»†äº†ã€‚è´´èŠ±è¿™é¡¹æŠ€æœ¯åœ¨å®˜æ–¹demoä¸­è¢«ç§°ä¸ºâ€œDecalsâ€ï¼Œå…¶åŸç†ä»Šå¤©å°±è¿‡å¤šèµ˜è¿°ï¼Œåç»­å†å‡ºä¸€ç¯‡æ–‡ç« ä¸“é—¨æ¥è®²decalsèƒŒåçš„åŸç†ï¼Œä»Šå¤©æˆ‘ä»¬å°±ç€é‡äºä½¿ç”¨å³å¯ã€‚



ä¸è¿‡åœ¨è¿™ä¹‹å‰æˆ‘ä»¬è¿˜æ˜¯å¯¹ä»£ç é€»è¾‘ç¨ä½œæ¢³ç†ã€‚

## é€»è¾‘æ¢³ç†

çºµè§‚æ•´ä¸ªä»£ç ï¼Œè¿˜æ˜¯æ¯”è¾ƒç®€å•ã€‚ä¸»è¦åˆ†ä¸ºä»¥ä¸‹å‡ å—ï¼š

1. åŠ è½½æ¨¡å‹
   1. åŠ è½½æ¨¡å‹æ–‡ä»¶æœ¬èº«
   2. åŠ è½½è´´èŠ±è´´å›¾
   3. åŠ è½½å¤©ç©ºç›’èƒŒæ™¯å›¾
2. æ­å»ºåœºæ™¯
   1. è®¾ç½®ç›¸æœº
   2. è®¾ç½®å…‰ç…§
3. å°„çº¿æ£€æµ‹
   1. å½“é¼ æ ‡åœ¨åœºæ™¯ä¸­ç§»åŠ¨æ—¶ï¼Œæ£€æµ‹æ˜¯å¦ä¸æ¨¡å‹ç›¸äº¤
4. æ·»åŠ è´´èŠ±åˆ°åœºæ™¯ä¸­
   1. å¦‚æœé¼ æ ‡ç‚¹å‡»æ—¶ä¸æ¨¡å‹ç›¸äº¤ï¼Œå°±åœ¨æ­¤å¤„åŠ ä¸€ä¸ªè´´èŠ±
5. æ‰§è¡Œä¸»å¾ªç¯æ¸²æŸ“



æˆ‘ä»¬è¦åšçš„ä¸»è¦å°±æ˜¯å¢åŠ è´´èŠ±çš„çº¹ç†æ•°é‡ï¼Œè¿˜æœ‰å°±æ˜¯å¯¹å†™ä¸€ä¸ªè‡ªå®šä¹‰çš„æè´¨è®©è´´èŠ±çœ‹èµ·æ¥æ›´åŠ çš„æ˜æ˜¾ã€‚

å¢åŠ çº¹ç†æ•°é‡è¿™ä¸ªå¾ˆç®€å•ï¼Œæˆ‘ä»¬åªéœ€è¦ä½¿ç”¨ä¸€ä¸ªæ•°ç»„æ¥ä¿å­˜å°±å¥½å•¦~æ¯”å¦‚ï¼š

```typescript
const decalTextureUrls = [
    withBase('decals/bianpao.png'),
    withBase('decals/denglong.png'),
    withBase('decals/dragon.png'),
    withBase('decals/fu-cute.png'),
    withBase('decals/fu.png'),
    withBase('decals/qianbi.png'),
    withBase('decals/qiandai.png'),
    withBase('decals/yuanbao.png'),
];
const decalTextures = decalTextureUrls.map(url => {
    return textureLoader.load(url);
});
```



æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦å£°æ˜ä¸€ä¸ªè‡ªå®šä¹‰Shaderçš„æè´¨æ¥è®©è´´èŠ±çš„æ¸²æŸ“æ›´åŠ çš„æ˜æ˜¾ï¼ï¼ï¼

```typescript
function initDecalMaterial(): THREE.Material {
    const customMaterial = new THREE.ShaderMaterial({
        vertexShader: plainVert,
        fragmentShader: plainFrag,
        depthTest: true,
        depthWrite: false,
        uniforms: {
            mainTex: {
                value: decalTextures[0],
            },
        },
        polygonOffset: true,
        polygonOffsetFactor: -4,
        wireframe: false,
        blending: THREE.CustomBlending,
        blendSrc: THREE.SrcAlphaFactor,
        blendDst: THREE.OneMinusSrcAlphaFactor,
    });
    return customMaterial;
}
```

æˆ‘ä»¬éœ€è¦æ³¨æ„çš„æ˜¯æˆ‘ä»¬éœ€è¦å¼€å¯é€æ˜åº¦æ··åˆï¼Œå¦åˆ™PNGå›¾ç‰‡åœ¨æ¨¡å‹ä¸Šé€æ˜çš„éƒ¨åˆ†çœ‹èµ·æ¥å°±æ˜¯é»‘é»¢é»¢çš„ä¸€ç‰‡ã€‚æ‰€ä»¥æˆ‘ä»¬è¦é€šè¿‡è®¾ç½® `blending`, `blendSrc`å’Œ `blendDst` è¿™ä¸‰ä¸ªå€¼æ¥ä¿è¯æ··åˆçš„æ­£ç¡®æ€§ã€‚

è¿˜æœ‰å¦å¤–ä¸€ç‚¹ä¹Ÿå¾ˆé‡è¦ï¼Œå°±æ˜¯`polygonOffset`ä¸`polygonOffsetFactor`ã€‚`polygonOffset` å’Œ `polygonOffsetFactor` æ˜¯ä¸¤ä¸ªä¸æ·±åº¦ç¼“å†²ç›¸å…³çš„å±æ€§ï¼Œå®ƒä»¬é€šå¸¸ç”¨äºè§£å†³Z-ç¼“å†²å†²çªï¼ˆZ-fightingï¼‰çš„é—®é¢˜ã€‚

1. **`polygonOffset`ï¼š**
   - `polygonOffset` æ˜¯ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œé»˜è®¤ä¸º `false`ã€‚å½“è®¾ç½®ä¸º `true` æ—¶ï¼Œå®ƒå¯ç”¨å¤šè¾¹å½¢åç§»ã€‚å¤šè¾¹å½¢åç§»æ˜¯ä¸€ç§é€šè¿‡å¾®è°ƒæ·±åº¦å€¼æ¥è§£å†³Z-ç¼“å†²å†²çªçš„æŠ€æœ¯ã€‚
2. **`polygonOffsetFactor`ï¼š**
   - `polygonOffsetFactor` æ˜¯ä¸€ä¸ªæµ®ç‚¹æ•°ï¼Œè¡¨ç¤ºåœ¨æ·±åº¦å€¼åç§»ä¸­çš„æ¯”ä¾‹å› å­ã€‚å®ƒæ§åˆ¶å¤šè¾¹å½¢åç§»çš„å…·ä½“ç¨‹åº¦ã€‚å€¼è¶Šå¤§ï¼Œåç§»è¶Šæ˜æ˜¾ã€‚

å½“å¯ç”¨äº† `polygonOffset` å¹¶è®¾ç½®äº†åˆé€‚çš„ `polygonOffsetFactor` å’Œ `polygonOffsetUnits`ï¼ˆåè€…æ˜¯å¦ä¸€ä¸ªå±æ€§ï¼Œè¡¨ç¤ºæ·±åº¦å€¼åç§»çš„å•ä½ï¼‰ï¼Œæ¸²æŸ“å¼•æ“ä¼šæ ¹æ®å¤šè¾¹å½¢çš„æ·±åº¦å€¼è¿›è¡Œå¾®å°çš„è°ƒæ•´ï¼Œä»è€Œé¿å…Z-ç¼“å†²å†²çªã€‚è¿™å¯¹äºå¤„ç†è¿‘ä¼¼å¹³è¡Œçš„è¡¨é¢æˆ–è€…ä½¿ç”¨é€æ˜åº¦çš„æè´¨æ—¶ç‰¹åˆ«æœ‰ç”¨ã€‚



æˆ‘ä»¬ä¸Šé¢ä½¿ç”¨çš„è‡ªå®šä¹‰shaderçš„ä»£ç å¦‚ä¸‹ï¼š

é¡¶ç‚¹ç€è‰²å™¨ `plainVert`:

```glsl
#include <common>
varying vec2 vUv;
void main() {
    vUv = uv;
    vec4 mvPosition = vec4(position, 1.0);
    mvPosition = modelViewMatrix * mvPosition;
    gl_Position = projectionMatrix * mvPosition;
}

```

ç‰‡æ®µç€è‰²å™¨ï¼š

```glsl
uniform sampler2D mainTex;
varying vec2 vUv;

void main () {
    vec4 color = texture(mainTex, vUv);
    gl_FragColor = color;
}
```

ä¸Šé¢çš„ä»£ç éƒ½éå¸¸çš„ç®€å•ï¼Œå°±ä¸å†èµ˜è¿°å•¦~



æœ€åçš„æœ€åæˆ‘ä»¬åªéœ€è¦åœ¨`shoot`å‡½æ•°ä¸­ç”Ÿæˆè´´èŠ±çš„åœ°æ–¹ç»™è´´å›¾åŠ å…¥ä¸€ç‚¹éšæœºæ€§ï¼Œå°±å¥½å•¦

```typescript
function shoot() {
    position.copy(intersection.point);
    orientation.copy(mouseHelper.rotation);
    if (params.rotate) orientation.z = Math.random() * 2 * Math.PI;

    const scale =
        params.minScale +
        Math.random() * (params.maxScale - params.minScale);
    size.set(scale, scale, scale);

    const material = customMaterial.clone();
    let index = Math.floor(Math.random() * decalTextures.length);
    (material as THREE.ShaderMaterial).uniforms.mainTex.value =
        decalTextures[index];
    // çœç•¥ä¸‹é¢çš„ä»£ç 
}
```



ç»è¿‡æˆ‘ä»¬çš„ç•¥å¾®æ”¹é€ ï¼Œæˆ‘ä»¬çš„æœ€ç»ˆå®ç°æ•ˆæœå¦‚ä¸‹ï¼š





# æ€»ç»“

ä»Šå¤©æˆ‘ä»¬åˆ©ç”¨THREEJSçš„è´´èŠ±åŠŸèƒ½å’Œæ–¯å¦ç¦é¾™å®Œæˆäº†ä¸€ä¸ªé¾™å¹´çš„å°å°åˆ›æ„ã€‚ä»£ç å¾ˆç®€å•ï¼Œå¸Œæœ›è¿™ç®€çŸ­çš„ä»£ç èƒ½ä¸ºä½ çš„ç”Ÿæ´»å¸¦æ¥ä¸€æŠ¹äº®è‰²ã€‚

æœ€åçš„æœ€åï¼Œè¿˜æ˜¯è¦ç¥å„ä½æ–°å¹´å¿«ä¹å•¦~

