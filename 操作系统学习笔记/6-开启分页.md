# 操作系统学习（六）—— 开启分页

一个逻辑地址如何映射到真实的物理地址？

![image-20231127144651329](https://picbed-1255660905.cos.ap-chengdu.myqcloud.com/doc/image-20231127144651329.png)



每页的大小为4KB

假设内存大小为4GB，所以一共有 4GB / 4KB = 1M 个页



高20位表示页表索引，

低12位表示页内偏移地址



## 一级页表将线性地址转换成物理地址的过程

![img](https://picbed-1255660905.cos.ap-chengdu.myqcloud.com/doc/1655717430!figure_largeshow.jpg)

0x0:0x1234



0x1234 --> 0000_0000_0000_0000_0001_0010_0011_0100

低12位：0010_0011_0100  -> 0x234

高20位：0000_0000_0000_0000_0001



0x0:0x1234 --> 0x9234



## 二级页表

每页的大小是固定的，为4KB，所以4GB的内存需要1M个页。

1级页表是将1M个页放置到一张页表中，而2级页表是将1M个页表放置在1张目录页中，目录页中有1024个目录，每个目录对应一张表，此表也有1024个”项“，1024 * 1024 = 1M

目录页被称为：页目录项 PDE (Page Directory Entry)

第二个表中的”项“称为：页表项 PTE (Page Table Entry)



对于2级页表来说：

高10位表示：页表的索引，也就是用于在页目录表中定位一个 PDE

中间10位表示：物理页的索引，也就是用于在页表内定位到某个页表项PTE

低12位表示：页内偏移



由于 PDE 与 PTE 都是4字节大小，所以在获得PDE和PTE之后需要乘以4，再加上页表的物理地址，才是最终要方位的绝对物理地址。

步骤如下：

1. 虚拟地址的高10位乘以4，作为页目录表的偏移地址，加上页目录表的物理地址所得的和就是页目录项的物理地址。读取该页目录项，从中获取到页表的物理地址
2. 用虚拟地址的中间10位乘以4，作为页表内的偏移地址，加上第一步中得到的页表物理地址，所得的和，便是页表项的物理地址。读取该页表项，获取到分配的物理页地址。
3. 从虚拟地址的低12位加上第2步中得到的物理页地址，所得的和就是最终转换的物理页



![img](https://picbed-1255660905.cos.ap-chengdu.myqcloud.com/doc/1655717841!figure_largeshow.jpg)

比如：0x0:0x01234567

--> 0000_0001_0010_0011_0100_0101_0110_0111

低12位：0x567

中间10位：0x234

高10位：0x4



1. 0x4 -> 0x4 * 4 -> 0x10 -> 读取0x10 = 0x1000
2. 0x234 -> 0x234 * 4 -> 0x8d0 + 0x1000 -> 读取 0x18d0 = 0xfa000
3. 0xfa000 + 0x567 = 0xfa567



## PDE 与 PTE 的结构

![img](https://picbed-1255660905.cos.ap-chengdu.myqcloud.com/doc/1655718343!figure_largeshow.jpg)

## 启用分页机制

1. 准备好页目录表及页表
2. 将页表地址写入控制寄存器cr3
3. 寄存器 cr0的PG位置1



cr3用于存储页表物理地址，所以cr3寄存器又称为页目录基址寄存器(Page Directory Base Register, PDBR)

![img](https://picbed-1255660905.cos.ap-chengdu.myqcloud.com/doc/1655718527!figure_largeshow.jpg)

页目录表所在地址要求在一个自然页内，及页目录的起始地址是4KB的整数倍



PCD，PWT位用于设置告诉缓存相关的特性，在此将其置为0即可。

控制寄存器可以与通用寄存器互相传递数据，可以使用mov指令：

mov cr[0~7], r32 或 mov r32, cr[0~7]



### cr0的PG位置0：

PG位是cr0寄存器的最后一位（第31位）



### 规划页表之操作系统与用户进程的关系

将4GB虚拟地址空间分成两部分，一部分专门划给操作系统，另一部分就归用户进程使用。

这里我们将高3GB以上的空间划分给操作系统，0~3GB划给用户。



为了实现共享操作系统，也就是所有进程的虚拟地址3GB~4GB的虚拟地址空间都指向同一片物理页地址。



页目录表的位置，我们就放在 0x100000处，由于页目录表占据4KB的空间，所以第一个页表的地址是 0x101000，第二个页表的地址是0x102000





开启分页后GDT表的变化：

![img](https://picbed-1255660905.cos.ap-chengdu.myqcloud.com/doc/1655719927!figure_largeshow.jpg)